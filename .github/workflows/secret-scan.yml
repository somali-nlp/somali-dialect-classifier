# Secret Scanning Workflow for Somali Dialect Classifier
# Detects accidentally committed secrets using Gitleaks and TruffleHog
# Runs on: push, pull_request, and scheduled weekly scans

name: Secret Scanning

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
      - 'hotfix/**'
  pull_request:
    branches:
      - main
      - develop
  schedule:
    # Weekly scan every Monday at 3 AM UTC
    - cron: '0 3 * * 1'
  workflow_dispatch: # Allow manual triggering

# Cancel in-progress runs for same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # Gitleaks Scanning
  # ============================================================================
  gitleaks:
    name: Gitleaks Secret Detection
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for comprehensive scanning

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }} # Optional: for Gitleaks Pro features
        with:
          config-path: .gitleaks.toml

      - name: Upload Gitleaks SARIF report
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif
          category: gitleaks
        continue-on-error: true

  # ============================================================================
  # TruffleHog Scanning
  # ============================================================================
  trufflehog:
    name: TruffleHog Secret Detection
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for comprehensive scanning

      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          # Scan entire git history
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified --json --debug

  # ============================================================================
  # Custom Secret Patterns (Backup Scan)
  # ============================================================================
  custom-patterns:
    name: Custom Pattern Detection
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Scan for Apify API tokens
        run: |
          echo "Scanning for Apify API tokens..."
          if grep -r "apify_api_[A-Za-z0-9]\{40\}" \
            --exclude-dir=".git" \
            --exclude-dir=".archive" \
            --exclude-dir="node_modules" \
            --exclude="*.lock" \
            --exclude=".gitleaks.toml" \
            --exclude="secret-scan.yml" \
            --exclude="*.example*" \
            . ; then
            echo "ERROR: Apify API token pattern detected!"
            echo "Please remove secrets and use .env files instead."
            exit 1
          else
            echo "No Apify tokens found in repository."
          fi

      - name: Scan for PostgreSQL passwords
        run: |
          echo "Scanning for PostgreSQL passwords in committed files..."
          if grep -r "POSTGRES_PASSWORD=" \
            --exclude-dir=".git" \
            --exclude-dir=".archive" \
            --exclude-dir="docs" \
            --exclude="*.example*" \
            --exclude="secret-scan.yml" \
            --exclude=".gitleaks.toml" \
            . ; then
            echo "ERROR: PostgreSQL password detected in committed files!"
            echo "Please remove secrets and use .env files instead."
            exit 1
          else
            echo "No PostgreSQL passwords found in repository."
          fi

      - name: Scan for private keys
        run: |
          echo "Scanning for private key files..."
          if grep -r "BEGIN.*PRIVATE KEY" \
            --exclude-dir=".git" \
            --exclude-dir=".archive" \
            . ; then
            echo "ERROR: Private key detected!"
            echo "Please remove private keys immediately."
            exit 1
          else
            echo "No private keys found in repository."
          fi

      - name: Verify .env files are not committed
        run: |
          echo "Verifying .env files are properly ignored..."
          if git ls-files | grep -E "^\.env$|^\.env\.local$|^\.env\.production$" ; then
            echo "ERROR: .env files are committed to git!"
            echo "Files found:"
            git ls-files | grep "\.env"
            echo ""
            echo "Please remove these files using:"
            echo "  git rm --cached .env .env.local .env.production"
            echo "  git commit -m 'chore(security): remove committed .env files'"
            exit 1
          else
            echo ".env files are properly ignored."
          fi

      - name: Check .gitignore configuration
        run: |
          echo "Verifying .gitignore has secret patterns..."
          if grep -q "\.env\*" .gitignore && grep -q "\*\.key" .gitignore ; then
            echo ".gitignore is properly configured for secrets."
          else
            echo "WARNING: .gitignore may not properly exclude secrets!"
            echo "Please ensure .gitignore contains:"
            echo "  .env*"
            echo "  !.env.example"
            echo "  *.key"
            exit 1
          fi

  # ============================================================================
  # Security Report Generation
  # ============================================================================
  security-report:
    name: Generate Security Report
    runs-on: ubuntu-latest
    needs: [gitleaks, trufflehog, custom-patterns]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create security scan summary
        run: |
          echo "# Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Scan Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Tool | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Gitleaks | ${{ needs.gitleaks.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TruffleHog | ${{ needs.trufflehog.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Custom Patterns | ${{ needs.custom-patterns.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.gitleaks.result }}" == "success" ]] && \
             [[ "${{ needs.trufflehog.result }}" == "success" ]] && \
             [[ "${{ needs.custom-patterns.result }}" == "success" ]]; then
            echo "**Overall Status:** PASS - No secrets detected" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Overall Status:** FAIL - Secrets detected or scan error" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please review the failed jobs above for details." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if any scan failed
        if: needs.gitleaks.result != 'success' || needs.trufflehog.result != 'success' || needs.custom-patterns.result != 'success'
        run: |
          echo "One or more security scans failed."
          echo "Please review the job logs for details."
          exit 1

# ============================================================================
# Workflow Configuration Notes
# ============================================================================

# 1. Branch Protection:
#    - Set this workflow as a required status check in branch protection rules
#    - Prevent merging PRs if secret scanning fails
#    - Configure in: Settings > Branches > Branch protection rules

# 2. SARIF Upload (GitHub Advanced Security):
#    - Requires GitHub Advanced Security (available for public repos and GitHub Enterprise)
#    - SARIF results appear in Security > Code scanning alerts
#    - If not available, the upload step will be skipped (continue-on-error: true)

# 3. TruffleHog Verified Secrets:
#    - --only-verified flag checks if secrets are actually valid
#    - Reduces false positives by verifying against actual services
#    - May increase scan time but improves accuracy

# 4. Custom Patterns:
#    - Provides backup detection for project-specific secrets
#    - Catches patterns that Gitleaks/TruffleHog might miss
#    - Uses simple grep for fast scanning

# 5. Scheduled Scans:
#    - Weekly scan on Monday at 3 AM UTC
#    - Catches secrets that might slip through PR reviews
#    - Provides regular security audits

# 6. Manual Triggering:
#    - workflow_dispatch allows manual runs from Actions tab
#    - Useful for testing or ad-hoc security audits
#    - Can be triggered via GitHub UI or API

# 7. Performance Optimization:
#    - Concurrency group cancels duplicate runs for same PR
#    - fetch-depth: 0 ensures full history scan
#    - Jobs run in parallel for faster results

# 8. Failure Handling:
#    - security-report job runs even if scans fail (if: always())
#    - Provides summary of all scan results
#    - Fails workflow if any scan detects secrets

# ============================================================================
# Testing This Workflow
# ============================================================================

# Local testing with act (GitHub Actions local runner):
#   act -j gitleaks
#   act -j trufflehog
#   act -j custom-patterns

# Manual trigger via GitHub CLI:
#   gh workflow run secret-scan.yml

# View workflow results:
#   gh run list --workflow=secret-scan.yml
#   gh run view <run-id>

# ============================================================================
# Troubleshooting
# ============================================================================

# False Positives:
#   - Update .gitleaks.toml allowlist
#   - Add patterns to custom-patterns exclusions
#   - Use .gitleaks-baseline.json for known secrets

# Scan Failures:
#   - Check Gitleaks version compatibility
#   - Verify .gitleaks.toml syntax
#   - Review custom pattern regex

# Performance Issues:
#   - Reduce fetch-depth for faster scans (but less comprehensive)
#   - Split large repositories into multiple scans
#   - Use baseline files to skip known secrets

# SARIF Upload Errors:
#   - Ensure GitHub Advanced Security is enabled
#   - Check SARIF file format
#   - Review codeql-action version compatibility
