name: Deploy Enhanced Dashboard to GitHub Pages

on:
  push:
    branches:
      - main
    paths:
      - 'data/metrics/**'
      - 'data/reports/**'
      - 'dashboard/**'
      - 'scripts/**'
      - '.github/workflows/deploy-dashboard-v2.yml'
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install pydantic numpy

      - name: Build dashboard site
        run: |
          # Step 1: Create site structure and copy static assets
          # - Creates _site/ and _site/data/ directories
          # - Copies index.html template
          # - Copies favicon, metrics/, and reports/ directories
          # - Does NOT generate all_metrics.json (done in next step)
          chmod +x dashboard/build-site.sh
          ./dashboard/build-site.sh

      - name: Generate metrics data
        run: |
          # Step 2: Use the proper export script that includes filter_breakdown support
          # - This script is maintained in scripts/export_dashboard_data.py
          # - It handles Pydantic schema validation and extracts all metrics including filter_breakdown
          # - Generates _site/data/all_metrics.json, summary.json, and reports.json
          python scripts/export_dashboard_data.py

          # Step 2b: Generate quality feed data (alerts and waivers)
          # - Parses quality reports from data/reports/ directory
          # - Generates dashboard/data/quality_alerts.json and quality_waivers.json
          # - Links to actual quality reports for transparency
          python scripts/generate_quality_feed.py

      - name: Verify build
        run: |
          # Step 3: Verify all required files are present before deployment
          # - Ensures _site/data/all_metrics.json exists (critical for dashboard)
          # - Displays structure and content preview
          echo "ğŸ“¦ Build verification:"
          echo ""
          echo "ğŸ“„ Site structure:"
          ls -lh _site/
          echo ""
          echo "ğŸ“ Data directory:"
          ls -lh _site/data/
          echo ""
          if [ -f "_site/data/all_metrics.json" ]; then
            echo "âœ… all_metrics.json exists"
            echo "ğŸ“Š Metrics preview:"
            head -20 _site/data/all_metrics.json
          else
            echo "âŒ ERROR: all_metrics.json not found!"
            exit 1
          fi
          echo ""
          echo "âœ… Build verification complete"

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Summary
        run: |
          echo "ğŸš€ Deployment complete!"
          echo "ğŸ“Š Dashboard URL: https://somali-nlp.github.io/somali-dialect-classifier/"
