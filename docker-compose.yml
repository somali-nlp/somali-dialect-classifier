# Docker Compose configuration for Somali NLP Data Pipeline
# Supports both development and production profiles
#
# Updated to use pyproject.toml for dependency management (Stage 1.3)
# See docs/guides/docker.md for usage instructions

services:
  # Development service - hot reload, interactive shell
  somali-nlp-dev:
    build:
      context: .
      dockerfile: docker/Dockerfile
    image: somali-nlp:latest
    container_name: somali-dialect-pipeline-dev

    profiles:
      - dev

    volumes:
      # Mount source code for hot reload
      - ./src:/app/src
      - ./scripts:/app/scripts
      - ./data:/app/data
      - ./logs:/app/logs
      # Preserve Python cache for faster dev iterations
      - dev-cache:/app/.cache

    environment:
      - ENV=development
      - PYTHONUNBUFFERED=1

    env_file:
      - .env

    # Interactive shell for development
    stdin_open: true
    tty: true

    # Override CMD to start bash
    command: /bin/bash

    networks:
      - somali-nlp-network

  # Production service - optimized, resource-limited
  somali-nlp-prod:
    build:
      context: .
      dockerfile: docker/Dockerfile
    image: somali-nlp:latest
    container_name: somali-dialect-pipeline-prod

    profiles:
      - prod

    volumes:
      # Persistent volumes for production data
      - data-volume:/app/data
      - logs-volume:/app/logs
      # Optional: mount backups directory
      - ./backups:/app/backups

    environment:
      - ENV=production
      - PYTHONUNBUFFERED=1

    env_file:
      - .env

    # Restart policy for production
    restart: unless-stopped

    # Resource limits to prevent runaway processes
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
        reservations:
          cpus: '2'
          memory: 4G

    # Default production command - run orchestrator
    command: python -m somali_dialect_classifier.orchestration.flows --pipeline all

    networks:
      - somali-nlp-network

    # Health check
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Optional: Backup service (can run on schedule)
  somali-nlp-backup:
    build:
      context: .
      dockerfile: docker/Dockerfile
    image: somali-nlp:latest
    container_name: somali-dialect-backup

    profiles:
      - backup

    volumes:
      - data-volume:/app/data:ro  # Read-only access to data
      - ./backups:/app/backups

    environment:
      - ENV=production

    # Run backup and exit
    command: python /app/scripts/backup_system.py

    networks:
      - somali-nlp-network

  # PostgreSQL service for production scale
  postgres:
    image: postgres:16-alpine
    container_name: somali-nlp-postgres

    profiles:
      - prod

    environment:
      POSTGRES_DB: ${POSTGRES_DB:-somali_nlp}
      POSTGRES_USER: ${POSTGRES_USER:-somali}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-somali_dev_password}
      POSTGRES_HOST_AUTH_METHOD: ${POSTGRES_AUTH_METHOD:-md5}

    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./migrations:/docker-entrypoint-initdb.d

    ports:
      - "${POSTGRES_PORT:-5432}:5432"

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U somali -d somali_nlp"]
      interval: 10s
      timeout: 5s
      retries: 5

    networks:
      - somali-nlp-network

    restart: unless-stopped

# Named volumes for production data persistence
volumes:
  data-volume:
    driver: local
  logs-volume:
    driver: local
  dev-cache:
    driver: local
  postgres_data:
    driver: local

# Network for container communication
networks:
  somali-nlp-network:
    driver: bridge
    name: somali-nlp-network
