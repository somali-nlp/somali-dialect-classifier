# Gitleaks Secret Scanning - Quick Reference

## Setup (One-Time)

Install the pre-commit hook to automatically scan before commits:

```bash
make secrets-install
```

This will:
- Install a pre-commit hook that runs on every commit
- Scan ONLY staged files (super fast, no CPU issues)
- Block commits if secrets are detected

## Daily Usage

### Before Committing (Manual Check)
```bash
make secrets-check
```
Fast scan of staged files only (~1 second).

### Full Repository Scan (Occasional)
```bash
make secrets-scan
```
Scans entire git history. Use sparingly (slower but comprehensive).

## How It Works

### ✅ Correct (What We're Using)
- `gitleaks protect` → Scans staged files only
- `gitleaks detect` → Scans git objects (tracked files + history)
- **No `--source .` flag** → Skips gitignored files automatically

### ❌ Wrong (CPU-Intensive)
- `gitleaks detect --source .` → Scans EVERYTHING including:
  - `data/` directories
  - `*.db` files
  - All gitignored files
  - Virtual environments
  - This causes high CPU usage!

## Configuration

Configuration file: `.gitleaks.toml`

Key settings:
- Custom rules for Apify, PostgreSQL, AWS, GitHub, HuggingFace tokens
- Excludes all gitignored directories (`data/`, `logs/`, `models/`, etc.)
- Excludes `.env.example` and test fixtures

## CI/CD Integration

GitHub Actions workflow: `.github/workflows/secret-scan.yml`

Runs on:
- Every push to main/develop
- Every pull request
- Weekly schedule (Mondays 3 AM UTC)
- Manual trigger

## Emergency Bypass

**Not recommended**, but if absolutely necessary:

```bash
git commit --no-verify
```

This bypasses the pre-commit hook. Only use if:
- You're 100% sure no secrets are present
- It's a false positive you've already verified
- You'll fix it in the next commit

## Performance

| Operation | Speed | What It Scans |
|-----------|-------|---------------|
| `make secrets-check` | ~1 sec | Staged files only |
| `make secrets-scan` | ~10-30 sec | Full git history |
| CI/CD scan | ~20-40 sec | Full repo + history |

## Troubleshooting

### False Positives
Edit `.gitleaks.toml` and add patterns to the `allowlist` section.

### High CPU Usage
Make sure you're using the Makefile commands, not running `gitleaks detect --source .` directly.

### Hook Not Running
```bash
# Reinstall the hook
make secrets-install

# Verify it exists
ls -la .git/hooks/pre-commit
```

## Best Practices

1. **Install the hook** - Let it catch secrets automatically
2. **Use `.env.example`** - Store templates, not real secrets
3. **Never commit `.env`** - Already in `.gitignore`
4. **Test locally** - Run `make secrets-check` before pushing
5. **Review CI results** - Check GitHub Actions for any issues

## Supported Secret Types

- Apify API tokens
- PostgreSQL passwords
- AWS access keys
- GitHub tokens
- HuggingFace tokens
- Private keys (RSA, EC, OpenSSH)
- Generic API keys
- JWT tokens
- And more (uses default gitleaks rules)

## Questions?

See full documentation:
- Gitleaks: https://github.com/gitleaks/gitleaks
- Configuration: `.gitleaks.toml`
- CI workflow: `.github/workflows/secret-scan.yml`
